# 過期工作自動處理功能說明

## 功能概述

系統會自動檢查並處理過期的工作，對未完成的工作進行扣點處理，並記錄到歷史紀錄中標示為逾期。

## 過期規則

### 判定標準
- **過期時間**：超過截止日期的當天 23:59:59
- **處理對象**：狀態為「進行中」的工作
- **扣點規則**：扣除該工作的原始點數

### 範例
- 工作截止日期：2026/01/17 20:00
- 過期時間：2026/01/17 23:59:59 之後
- 如果到 2026/01/18 00:00:00 還沒完成，就會被標記為過期

## 自動處理機制

### 觸發時機
系統會在以下時機自動檢查並處理過期工作：
1. 父母開啟「控制台」頁面時
2. 父母開啟「工作管理」頁面時
3. 子女開啟「我的工作」頁面時
4. 可以手動呼叫 API：`POST /api/jobs/expired`

### 處理流程
1. **檢查過期**：找出所有超過截止日期當天的進行中工作
2. **扣除點數**：從子女帳戶扣除該工作的點數
3. **更新狀態**：將工作標記為「已完成」，但實際點數為負數
4. **記錄交易**：創建扣點交易記錄
5. **顯示歷史**：在工作歷史中標示為「逾期未完成」


## 顯示方式

### 工作歷史頁面
在子女的「完成歷史」頁面中，過期工作會顯示：
- ⚠️ 逾期未完成（紅色標記）
- 點數顯示為紅色負數：-XX 點
- 仍然會出現在「已完成工作」列表中

### 統計數據
- 累計獲得點數會扣除過期工作的點數
- 子女的總點數會相應減少（最低為 0）

## 範例場景

### 場景 1：工作過期扣點
- **工作**：整理房間（20 點）
- **截止日期**：2026/01/17 20:00
- **狀況**：子女接取後一直沒完成
- **結果**：
  - 2026/01/18 00:00:00 後，系統自動處理
  - 從子女帳戶扣除 20 點
  - 工作標記為「逾期未完成」
  - 記錄到歷史中，顯示 -20 點

### 場景 2：週期性工作過期
- **工作**：每天倒垃圾（10 點）
- **週期**：每天
- **狀況**：週一的工作沒完成
- **結果**：
  - 週二 00:00:00 後，週一的工作被標記為過期
  - 扣除 10 點
  - 週二仍然會生成新的工作
  - 子女可以繼續完成週二的工作

## 與逾期折扣的區別

### 逾期折扣（在截止日期後 2 小時內完成）
- 逾期 1 小時內：70% 點數
- 逾期 1.5 小時內：50% 點數
- 逾期 2 小時內：30% 點數
- 逾期超過 2 小時：0 點
- **仍然可以提交完成**

### 過期扣點（超過截止日期當天）
- 超過當天 23:59:59
- **自動扣除點數**
- **無法再提交**
- 標記為「逾期未完成」

## 防止過期的建議

### 給子女的建議
1. 每天檢查「我的工作」頁面
2. 注意截止日期和倒數計時
3. 優先完成即將到期的工作
4. 如果無法完成，提前告知父母

### 給父母的建議
1. 設定合理的截止日期
2. 使用 iCalendar 功能提醒子女
3. 定期檢查子女的工作進度
4. 對於重要工作，可以提前提醒

## 技術細節

### 相關檔案
- `lib/utils/expired-jobs.ts` - 過期工作處理工具函數
- `app/api/jobs/expired/route.ts` - 過期工作處理 API
- `app/(child)/job-history/page.tsx` - 工作歷史頁面（顯示逾期標記）

### API 端點
- `POST /api/jobs/expired` - 檢查並處理過期工作
- `GET /api/jobs/expired` - 同上（手動觸發）

### 資料結構
```typescript
// 過期工作的標記
{
  status: 'approved',      // 狀態設為已完成
  actualPoints: -20,       // 實際點數為負數
  discount: -100,          // 折扣為 -100% 表示過期扣點
  approvedAt: '...'        // 自動處理時間
}

// 扣點交易記錄
{
  userId: 'child-id',
  amount: -20,             // 負數表示扣點
  type: 'earn',
  description: '工作逾期扣點：整理房間',
  relatedId: 'job-id'
}
```

## 注意事項

1. **點數不會低於 0**：即使扣點，子女的總點數最低為 0
2. **自動處理**：不需要父母手動操作
3. **無法撤銷**：過期扣點後無法恢復
4. **歷史記錄**：所有過期工作都會保留在歷史中
5. **週期性工作**：每個週期的工作獨立計算，不會互相影響

## 未來改進

- [ ] 支援過期前提醒通知
- [ ] 支援父母手動豁免過期扣點
- [ ] 支援設定寬限期（例如：過期後 1 天內仍可完成）
- [ ] 添加過期工作的統計報表
- [ ] 支援自訂扣點規則（例如：扣除 50% 而非全部）
