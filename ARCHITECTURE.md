# HomeBank V2 架構說明

## 資料庫架構

### 目前實作：Vercel Blob Storage

我們使用 Vercel Blob Storage 作為 JSON 檔案儲存，實作簡單的檔案型資料庫。

#### 運作原理

```
每個資料表 = 一個 JSON 檔案
- users.json      → 用戶資料
- jobs.json       → 工作任務
- rewards.json    → 獎勵項目
- transactions.json → 點數交易記錄
```

#### CRUD 操作流程

所有操作都遵循「讀取全部 → 修改記憶體 → 寫回全部」模式：

1. **Create（新增）**
   ```
   讀取檔案 → 在陣列中 push 新項目 → 寫回檔案
   ```

2. **Read（讀取）**
   ```
   讀取檔案 → 在記憶體中過濾/查詢 → 返回結果
   ```

3. **Update（更新）**
   ```
   讀取檔案 → 根據 ID 找到項目並更新屬性 → 寫回檔案
   ```

4. **Delete（刪除）**
   ```
   讀取檔案 → 過濾掉指定 ID 的項目 → 寫回檔案
   ```

### 優點

✅ **Serverless 友善**
- 不需要維護資料庫伺服器
- 自動擴展，按使用量付費
- 部署簡單，無需額外設定

✅ **實作簡單**
- 邏輯單純，易於理解和除錯
- 適合快速原型開發
- 學習曲線低

✅ **成本低**
- Vercel Blob 免費額度充足
- 小型應用幾乎零成本

### 限制與風險

⚠️ **並發問題 (Race Condition)**

**問題描述：**
當兩個使用者同時修改資料時，可能發生資料覆蓋：

```
時間軸：
T1: 用戶 A 讀取 users.json (有 10 個用戶)
T2: 用戶 B 讀取 users.json (有 10 個用戶)
T3: 用戶 A 新增用戶 X，寫回檔案 (11 個用戶)
T4: 用戶 B 新增用戶 Y，寫回檔案 (11 個用戶)
結果: 用戶 X 的資料遺失！
```

**影響範圍：**
- 父母同時新增子女帳號
- 多個子女同時接受工作
- 同時兌換獎勵

**緩解措施：**
- 目前使用場景並發量低（家庭使用）
- 前端有 loading 狀態防止重複提交
- 建議：未來改用支援事務的資料庫

⚠️ **效能瓶頸**

**問題描述：**
每次修改都需要讀寫整個檔案，隨著資料量增加效能下降：

```
資料量 vs 操作時間（估算）：
- 10 筆資料：  ~100ms
- 100 筆資料： ~200ms
- 1000 筆資料：~500ms
- 10000 筆資料：~2000ms
```

**影響範圍：**
- 用戶數量增加
- 工作/獎勵歷史累積
- 交易記錄增長

**緩解措施：**
- 定期清理舊資料
- 分頁載入（前端）
- 建議：資料量 >1000 筆時改用專業資料庫

⚠️ **無事務支援**

**問題描述：**
無法保證多個操作的原子性：

```
例如：兌換獎勵需要：
1. 扣除用戶點數
2. 減少獎勵庫存
3. 新增交易記錄

如果步驟 2 失敗，步驟 1 已經執行，造成資料不一致
```

**緩解措施：**
- 在應用層實作補償邏輯
- 詳細的錯誤日誌
- 建議：關鍵業務邏輯改用支援事務的資料庫

### 效能優化

#### 已實作的優化

✅ **移除不必要的刪除操作**

**優化前：**
```typescript
// 寫入時先刪除舊檔案
const existingUrl = await getBlobUrl(filename);
if (existingUrl) {
  await del(existingUrl);  // 額外的網路請求
}
await put(key, data);
```

**優化後：**
```typescript
// 直接覆蓋，Vercel Blob 會自動處理
await put(key, data, {
  addRandomSuffix: false  // 自動覆蓋同名檔案
});
```

**效能提升：**
- 減少 2 次網路請求（list + del）
- 寫入速度提升約 50%
- 降低並發衝突機率

✅ **快取控制**
```typescript
cacheControlMaxAge: 0  // 不快取，確保資料即時性
```

✅ **前端自動重新整理**
- 頁面獲得焦點時自動重新載入
- 減少使用者看到過期資料的機率

### 適用場景

✅ **適合使用的場景：**
- 小型家庭應用（<100 用戶）
- 低並發場景（<10 同時在線）
- 原型開發和測試
- 資料量小（<1000 筆記錄）

❌ **不適合的場景：**
- 高並發應用
- 大量資料（>10000 筆）
- 需要複雜查詢（JOIN、聚合等）
- 金融級資料一致性要求

## 未來改進方向

### 短期改進（保持 Serverless）

1. **使用 Vercel Postgres**
   - 支援事務
   - 更好的並發控制
   - SQL 查詢能力
   - 仍然是 Serverless

2. **實作樂觀鎖**
   ```typescript
   interface DataWithVersion {
     version: number;
     data: any[];
   }
   
   // 寫入時檢查版本號
   if (currentVersion !== expectedVersion) {
     throw new Error('資料已被其他人修改');
   }
   ```

3. **資料分片**
   - 按用戶 ID 分檔案
   - 減少單一檔案大小
   - 降低並發衝突

### 長期改進（擴展性）

1. **遷移到 PostgreSQL**
   - 完整的 ACID 支援
   - 複雜查詢能力
   - 更好的效能

2. **引入快取層**
   - Redis 快取熱門資料
   - 減少資料庫讀取

3. **事件溯源 (Event Sourcing)**
   - 記錄所有變更事件
   - 可追溯歷史
   - 更好的並發處理

## 監控建議

建議監控以下指標：

1. **資料量**
   - 每個檔案的記錄數
   - 檔案大小
   - 警告閾值：>1000 筆

2. **效能**
   - API 回應時間
   - Blob 讀寫延遲
   - 警告閾值：>1 秒

3. **錯誤率**
   - 並發衝突次數
   - 寫入失敗率
   - 警告閾值：>1%

## 總結

目前的 Blob Storage 實作適合 HomeBank V2 的初期使用場景（家庭內部使用，低並發）。隨著使用者增加或功能擴展，建議逐步遷移到更強大的資料庫解決方案。

**關鍵決策點：**
- 用戶數 >100：考慮 Vercel Postgres
- 並發問題頻繁：立即遷移到支援事務的資料庫
- 效能下降明顯：實作快取或資料分片
