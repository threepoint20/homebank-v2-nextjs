# iCalendar 功能測試指南

## 功能概述

父母在建立工作時，可以選擇下載 iCalendar (.ics) 檔案，將工作加入到 iCloud 行事曆。由於家庭成員都使用同一個 Apple ID，所有裝置（Mac/iPad/iPhone）都會自動同步顯示。

## 測試前準備

1. **確保已部署最新版本**
   ```bash
   git add .
   git commit -m "完成 iCalendar 功能實作"
   git push
   ```

2. **確認環境變數**
   - 不需要額外的環境變數
   - 系統會自動使用 `NEXT_PUBLIC_BASE_URL` 或預設的 Vercel 網址

## 測試步驟

### 1. 建立工作並下載行事曆檔案

1. 使用父母帳號登入
2. 進入「工作管理」頁面
3. 點擊「+ 建立新工作」
4. 填寫工作資訊：
   - 工作名稱：例如「整理房間」
   - 工作描述：例如「清理書桌和床鋪」
   - 獎勵點數：例如 50
   - **指派給**：選擇特定子女（必須）
   - **截止日期**：選擇日期和時間（必須）
5. 勾選「📅 下載行事曆檔案（.ics）」
6. 點擊「建立」按鈕
7. **預期結果**：
   - 顯示成功訊息：「✅ 工作已建立！行事曆檔案已下載，請點擊檔案加入到 iCloud 行事曆」
   - 瀏覽器自動下載 `HomeBank-整理房間.ics` 檔案

### 2. 加入到 iCloud 行事曆

#### 在 Mac 上：
1. 找到下載的 `.ics` 檔案（通常在「下載項目」資料夾）
2. 雙擊 `.ics` 檔案
3. 系統會自動開啟「行事曆」應用程式
4. 確認事件詳細資訊
5. 點擊「加入」按鈕
6. **預期結果**：
   - 事件已加入到 iCloud 行事曆
   - 可以在「行事曆」應用程式中看到工作

#### 在 iPad/iPhone 上：
1. 開啟「檔案」應用程式
2. 找到下載的 `.ics` 檔案
3. 點擊檔案
4. 選擇「加入到行事曆」
5. 確認並儲存
6. **預期結果**：
   - 事件已加入到 iCloud 行事曆
   - 可以在「行事曆」應用程式中看到工作

### 3. 驗證行事曆事件內容

開啟「行事曆」應用程式，找到剛才加入的事件，確認以下資訊：

1. **標題**：🎯 整理房間
2. **時間**：與設定的截止日期相同
3. **地點**：HomeBank 家庭銀行
4. **描述**：包含以下資訊
   - 工作描述
   - 💰 獎勵點數：50 點
   - 👤 指派者：父母名稱
   - ⏰ 逾期規則（完整的折扣說明）
   - 🔗 查看工作連結
5. **提醒**：應該有 3 個提醒
   - 截止前 1 小時
   - 截止前 30 分鐘
   - 截止前 10 分鐘

### 4. 驗證跨裝置同步

1. 在 Mac 上加入行事曆事件
2. 等待 1-2 分鐘（iCloud 同步時間）
3. 在 iPad 或 iPhone 上開啟「行事曆」應用程式
4. **預期結果**：
   - 事件已自動同步到所有裝置
   - 所有裝置都能看到相同的工作資訊

### 5. 測試提醒功能

1. 建立一個截止時間在 1 小時後的工作
2. 加入到行事曆
3. 等待提醒時間到達
4. **預期結果**：
   - 在截止前 1 小時、30 分鐘、10 分鐘收到提醒通知
   - 提醒內容包含工作名稱

## 測試案例

### 案例 1：完整流程測試
- **目的**：測試從建立工作到加入行事曆的完整流程
- **步驟**：按照上述「測試步驟」執行
- **預期結果**：所有步驟都能正常執行

### 案例 2：不勾選行事曆選項
- **步驟**：
  1. 建立工作時不勾選「下載行事曆檔案」
  2. 點擊「建立」
- **預期結果**：
  - 工作建立成功
  - 不會下載 .ics 檔案
  - 顯示訊息：「✅ 工作已建立！」

### 案例 3：沒有指派給特定子女
- **步驟**：
  1. 建立工作時「指派給」選擇「所有子女（待接取）」
  2. 設定截止日期
- **預期結果**：
  - 不顯示「下載行事曆檔案」選項
  - 因為沒有指派給特定子女，無法生成個人化的行事曆事件

### 案例 4：沒有設定截止日期
- **步驟**：
  1. 建立工作時指派給特定子女
  2. 不設定截止日期
- **預期結果**：
  - 不顯示「下載行事曆檔案」選項
  - 顯示提示：「💡 提示：設定截止日期後，可以選擇下載行事曆檔案加入到 iCloud 行事曆」

### 案例 5：多個工作同時加入
- **步驟**：
  1. 建立 3 個不同的工作，都勾選下載行事曆
  2. 將 3 個 .ics 檔案都加入到行事曆
- **預期結果**：
  - 所有 3 個工作都出現在行事曆中
  - 每個工作都有獨立的提醒

## 常見問題排查

### 問題 1：.ics 檔案沒有自動下載
**可能原因**：
- 瀏覽器阻擋了下載
- 沒有勾選「下載行事曆檔案」選項

**解決方法**：
- 檢查瀏覽器的下載設定
- 確認已勾選選項並且有指派給特定子女和設定截止日期

### 問題 2：無法加入到行事曆
**可能原因**：
- .ics 檔案格式錯誤
- 系統沒有安裝「行事曆」應用程式

**解決方法**：
- 檢查 .ics 檔案內容是否正確
- 確認裝置上有「行事曆」應用程式

### 問題 3：事件沒有同步到其他裝置
**可能原因**：
- iCloud 同步未開啟
- 網路連線問題
- 使用不同的 Apple ID

**解決方法**：
- 確認所有裝置都登入同一個 Apple ID
- 檢查「設定」→「Apple ID」→「iCloud」→「行事曆」是否開啟
- 確認網路連線正常

### 問題 4：沒有收到提醒
**可能原因**：
- 提醒功能未開啟
- 通知權限未授予

**解決方法**：
- 檢查「設定」→「通知」→「行事曆」是否允許通知
- 確認「行事曆」應用程式的提醒設定

## 技術細節

### iCalendar 檔案格式
- 使用標準的 iCalendar (RFC 5545) 格式
- 包含 VEVENT 事件
- 包含 VALARM 提醒

### 提醒時間
- 提醒 1：截止前 1 小時 (`-PT1H`)
- 提醒 2：截止前 30 分鐘 (`-PT30M`)
- 提醒 3：截止前 10 分鐘 (`-PT10M`)

### 檔案命名
- 格式：`HomeBank-{工作名稱}.ics`
- 特殊字元會被替換為 `-`

## 相關檔案

- `lib/calendar/icalendar.ts` - iCalendar 生成函數
- `app/api/calendar/generate/route.ts` - 生成 .ics 檔案的 API
- `app/(parent)/work-management/page.tsx` - 工作管理頁面（包含下載功能）
- `app/api/jobs/route.ts` - 工作 API（記錄 sendCalendarInvite 標記）

## 下一步

如果測試都通過，可以考慮：
1. 添加更多自訂選項（例如：自訂提醒時間）
2. 支援批次下載多個工作的行事曆檔案
3. 添加行事曆訂閱功能（讓子女可以訂閱所有工作）
